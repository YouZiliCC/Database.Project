{% extends "base.html" %}
{% block title %}WebShell - {{ project.pname }} - æ•°æ®åº“ç³»ç»Ÿè¯¾ç¨‹{% endblock %}
{% block styles %}
    <link rel="stylesheet"
          href="{{ url_for('static', filename='css/terminal.css') }}">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css">
    <style>
    /* ç¡®ä¿ç»ˆç«¯é¡µé¢å…¨å®½ */
    .container {
        max-width: 100% !important;
        padding: 0 !important;
    }
    
    /* ç¡®ä¿ç»ˆç«¯å®¹å™¨æ­£ç¡®æ˜¾ç¤º */
    .terminal-page {
        width: 100%;
        min-height: calc(100vh - 60px);
    }
    </style>
{% endblock %}
{% block content %}
    <div class="terminal-page">
        <div class="terminal-warning">
            <strong>âš ï¸ WebShell ç»ˆç«¯ä½¿ç”¨é¡»çŸ¥</strong>
            <ul>
                <li>è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„äº¤äº’å¼ Bash Shellï¼Œå¯ä»¥æ‰§è¡Œä»»æ„ Linux å‘½ä»¤</li>
                <li>æ‰€æœ‰æ“ä½œåœ¨ Docker å®¹å™¨æ²™ç®±ä¸­è¿›è¡Œï¼Œä¸å®¿ä¸»æœºå®Œå…¨éš”ç¦»</li>
                <li>æ”¯æŒ vimã€nano ç­‰ç¼–è¾‘å™¨ï¼Œæ”¯æŒ ANSI å½©è‰²è¾“å‡º</li>
                <li>æ”¯æŒæ ‡å‡†è¾“å…¥è¾“å‡ºé‡å®šå‘ã€ç®¡é“ã€åå°ä»»åŠ¡ç­‰ç‰¹æ€§</li>
                <li>è¯·è°¨æ…æ“ä½œï¼Œé¿å…è¯¯åˆ æ–‡ä»¶æˆ–ç ´åå®¹å™¨ç¯å¢ƒ</li>
                <li>é€€å‡ºå‘½ä»¤ï¼ˆexitï¼‰ä¼šå…³é—­ä¼šè¯ï¼Œå¯é€šè¿‡"é‡æ–°è¿æ¥"æŒ‰é’®æ¢å¤</li>
            </ul>
        </div>
        <div class="terminal-header">
            <h2>
                ğŸ–¥ï¸ WebShell ç»ˆç«¯ - {{ project.pname }}
                <span id="connection-status" class="connection-status status-connecting">è¿æ¥ä¸­...</span>
            </h2>
            <div class="project-info">
                å®¹å™¨ ID: {{ project.docker_name[:12] }} | ç«¯å£æ˜ å°„: {{ project.port }}:{{ project.docker_port }}
            </div>
        </div>
        <div class="terminal-wrapper">
            <div id="terminal-container"></div>
        </div>
        <div class="terminal-controls">
            <a href="{{ url_for('project.project_detail', pid=project.pid) }}"
               class="btn btn-back">â† è¿”å›é¡¹ç›®è¯¦æƒ…</a>
            <button id="btn-clear" class="btn btn-clear">ğŸ—‘ï¸ æ¸…ç©ºå±å¹•</button>
            <button id="btn-reconnect" class="btn btn-reconnect" style="display: none;">ğŸ”„ é‡æ–°è¿æ¥</button>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    <!-- Socket.IO å®¢æˆ·ç«¯åº“ - ä¸» CDN -->
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.2/dist/socket.io.min.js"
            crossorigin="anonymous"
            onerror="this.onerror=null; this.src='https://unpkg.com/socket.io-client@4.7.2/dist/socket.io.min.js'"></script>
    <!-- Xterm.js æ ¸å¿ƒåº“ - ä¸» CDN -->
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"
            crossorigin="anonymous"
            onerror="this.onerror=null; this.src='https://unpkg.com/xterm@5.3.0/lib/xterm.min.js'"></script>
    <!-- Xterm.js è‡ªé€‚åº”æ’ä»¶ - ä¸» CDN -->
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"
            crossorigin="anonymous"
            onerror="this.onerror=null; this.src='https://unpkg.com/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js'"></script>
    <!-- ç»ˆç«¯ JavaScript é€»è¾‘ -->
    <script src="{{ url_for('static', filename='js/terminal.js') }}"></script>
    <script>
    // ç­‰å¾…æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆååˆå§‹åŒ–ç»ˆç«¯
    function checkLibrariesLoaded() {
        // æ£€æŸ¥æ‰€æœ‰å¿…éœ€çš„åº“æ˜¯å¦å·²åŠ è½½
        if (typeof io === 'undefined') {
            console.error('Socket.IO æœªåŠ è½½');
            return false;
        }
        if (typeof Terminal === 'undefined') {
            console.error('Xterm.js æœªåŠ è½½');
            return false;
        }
        if (typeof FitAddon === 'undefined') {
            console.error('Xterm FitAddon æœªåŠ è½½');
            return false;
        }
        return true;
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ç»ˆç«¯
    window.addEventListener('load', function() {
        // æ·»åŠ ä¸€ä¸ªå°å»¶è¿Ÿç¡®ä¿æ‰€æœ‰è„šæœ¬éƒ½å·²æ‰§è¡Œ
        setTimeout(function() {
            try {
                if (!checkLibrariesLoaded()) {
                    throw new Error('ä¾èµ–åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }
                
                console.log('åˆå§‹åŒ– WebShell ç»ˆç«¯...');
                console.log('Terminal:', typeof Terminal);
                console.log('FitAddon:', typeof FitAddon);
                console.log('io:', typeof io);
                
                initTerminal("{{ project.pid }}");
            } catch (error) {
                console.error('ç»ˆç«¯åˆå§‹åŒ–å¤±è´¥:', error);
                const container = document.getElementById('terminal-container');
                if (container) {
                    container.innerHTML = `
                        <div style="color: #ef4444; padding: 20px; text-align: center; font-family: Arial, sans-serif;">
                            <h3 style="margin-bottom: 15px;">âŒ ç»ˆç«¯åˆå§‹åŒ–å¤±è´¥</h3>
                            <p style="margin: 10px 0;"><strong>é”™è¯¯ä¿¡æ¯:</strong> ${error.message}</p>
                            <p style="margin: 10px 0; color: #666;">å¯èƒ½çš„åŸå› ï¼š</p>
                            <ul style="text-align: left; display: inline-block; color: #666;">
                                <li>CDN èµ„æºåŠ è½½å¤±è´¥ï¼ˆæ£€æŸ¥ç½‘ç»œè¿æ¥ï¼‰</li>
                                <li>æµè§ˆå™¨ä¸å…¼å®¹ï¼ˆå»ºè®®ä½¿ç”¨ Chrome/Edge/Firefox æœ€æ–°ç‰ˆï¼‰</li>
                                <li>æµè§ˆå™¨æ‰©å±•é˜»æ­¢äº†è„šæœ¬åŠ è½½ï¼ˆå°è¯•ç¦ç”¨å¹¿å‘Šæ‹¦æˆªå™¨ï¼‰</li>
                            </ul>
                            <p style="margin-top: 20px;">
                                <button onclick="location.reload()" style="padding: 10px 20px; background: #0d6efd; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    ğŸ”„ åˆ·æ–°é¡µé¢é‡è¯•
                                </button>
                            </p>
                        </div>
                    `;
                }
            }
        }, 200);
    });
    
    // é˜²æ­¢é¡µé¢æ„å¤–å…³é—­
    window.addEventListener('beforeunload', function(e) {
        const statusEl = document.getElementById('connection-status');
        if (statusEl && statusEl.classList.contains('status-connected')) {
            const confirmationMessage = 'ç»ˆç«¯ä¼šè¯æ­£åœ¨è¿è¡Œï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
            e.returnValue = confirmationMessage;
            return confirmationMessage;
        }
    });
    </script>
{% endblock %}
